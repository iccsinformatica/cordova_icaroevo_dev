<!DOCTYPE html>

<html>

<head>
    <meta charset="utf-8">
    <!--meta http-equiv="Content-Security-Policy" content="default-src 'self' data: https://ssl.gstatic.com 'unsafe-eval'; style-src 'self' 'unsafe-inline'; media-src *; img-src 'self' data: content:;"-->
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="viewport"
        content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, viewport-fit=cover, height=device-height">
    <meta name="color-scheme" content="light dark">

    <link rel="stylesheet" href="./css/index.css">
    <link rel="stylesheet" href="./css/icaro.css">
    <link rel="stylesheet" href="./css/bootstrap.min.css">
    <link rel="stylesheet" href="./css/fontawesome-all.min.css">
    <link rel="stylesheet" href="./css/fontawesome.css">
    <link rel="stylesheet" href="./css/fontawesome.min.css">

    <script src="./cordova.js"></script>
    <script src="./js/index.js"></script>
    <script src="./js/bootstrap.bundle.min.js"></script>
    <script src="./js/jquery.min.js"></script>
    <script src="./js/icaro.js"></script>

    <style>
        .center {
            margin: 0;
            position: absolute;
            top: 50%;
            left: 50%;
            -ms-transform: translate(-50%, -50%);
            transform: translate(-50%, -50%);
        }
    </style>

    <title>Icaro Evo</title>
</head>

<body>
    <div class="div_header" id="div_header_small"></div>

    <div class="d-flex flex-row" style="position: relative;" id="back" name="back">
        <img src="./img/freccia_back.svg" onclick="back()">
    </div>

    <div id="div_container" name="div_container" style="margin-top: -10%;">
        <div class="fade-in-image" id="div_prestazione_dettaglio" name="div_prestazione_dettaglio">

        </div>

    </div>

</body>

</html>
<script>

    let searchParams = new URLSearchParams(window.location.search)
    var idgruppo = searchParams.get('idgruppo')
    var idtipoprestazione = searchParams.get('idtipoprestazione')
    var aIDTIPIPRESTAZIONI = idtipoprestazione.split(',');
    var descr_tipoprestazione = searchParams.get('descr_tipoprestazione')
    //alert(descr_tipoprestazione)
    var idstruttura = localStorage.getItem("idstruttura");
    var idente = localStorage.getItem('idente');
    var idIntervento = searchParams.get('idintervento')
    var codice_intervento = searchParams.get('codice')
    var idservizio = localStorage.getItem('idservizio');
    var access_token = localStorage.getItem("access_token");
    var realms = localStorage.getItem('realm');

    var pidprestazione = searchParams.get('_idprestazione')
    var ptabellone = searchParams.get('_tabellone')

    if (pidprestazione == null || pidprestazione == 'null' || pidprestazione == '')
        pidprestazione = localStorage.getItem('_idprestazione');

    var aIDPRESTAZIONI = []
    if (pidprestazione != null && pidprestazione != undefined && pidprestazione != '')
        aIDPRESTAZIONI = pidprestazione.split(',');

    var oggi = getDATA();
    document.addEventListener("deviceready", onDeviceReady, false);
    getHeader();
    refresh_token()
    function onDeviceReady() {
        var date_forcall = get_currentDATAFORCALL();
        $('#div_prestazione_dettaglio').append('<center><div id="div_spinner" class="lds-ripple"><div></div><div></div></div></center>')

        //$("#div_container").append('<div id="div_spinner" class="spinner-grow text-primary" role="status" style=" margin-left: 50%; margin-top: 50%;"><span class="visually-hidden">Caricamento in corso...</span></div>');
        //$("#div_spinner").hide();
        var aINTERVENTI = [];
        //Con la prima chiamata prendo l'id del soggetto
        var base_url = localStorage.getItem('base_url');

        var url = 'https://' + base_url + '/services/interventiservice/api/interventi/ricerca?id.equals=' + idIntervento;

        $.ajax({
            url: url,
            type: 'GET',
            xhrFields: { withCredentials: true },
            crossDomain: true,
            dataType: 'json',
            beforeSend: function (xhr) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + access_token);
                xhr.setRequestHeader('idEnte', idente);
                xhr.setRequestHeader('idStruttura', idstruttura);
            },
            success: function (res, textStatus, jqXHR) {

                if (res != undefined) {
                    var content = res.content

                    $.each(content, function (index, element) {
                        var soggetto = element.titolare.soggetto

                        var id_soggetto = soggetto.id
                        var idIcaro = soggetto.idIcaro
                        var codiceFiscale = soggetto.codiceFiscale
                        var nome = soggetto.nome
                        var cognome = soggetto.cognome
                        var sesso = soggetto.sesso
                        var dataNascita = soggetto.dataNascita
                        var codiceIstatNazioneNascita = soggetto.codiceIstatNazioneNascita
                        var luogoNascita = soggetto.luogoNascita
                        var indirizzoResidenza = soggetto.indirizzoResidenza

                        var indirizzoCompleto = indirizzoResidenza.indirizzoCompleto
                        var comune = indirizzoResidenza.comune
                        var provincia = indirizzoResidenza.provincia
                        //Prendo tutti i campi necessari del soggetto

                        var url = 'https://' + base_url + '/services/soggettiservice/api/soggetti/ricerca?id.equals=' + id_soggetto;

                        $.ajax({
                            url: url,
                            type: 'GET',
                            xhrFields: { withCredentials: true },
                            crossDomain: true,
                            dataType: 'json',
                            beforeSend: function (xhr) {
                                xhr.setRequestHeader('Authorization', 'Bearer ' + access_token);
                                xhr.setRequestHeader('idEnte', idente);
                                xhr.setRequestHeader('idStruttura', idstruttura);
                            },
                            success: function (result, textStatus, jqXHR) {
                                var content = result.content
                                //alert(JSON.stringify(content))
                                $.each(content, function (index, element) {
                                    var telefono1 = element.telefono1
                                    var telefono2 = element.telefono2
                                    var telefono3 = element.telefono3

                                    if (telefono1 == null)
                                        telefono1 = '';
                                    else
                                        telefono1 = '<li>' + telefono1 + '</li>';

                                    if (telefono2 == null)
                                        telefono2 = '';
                                    else
                                        telefono2 = '<li>' + telefono2 + '</li>';

                                    if (telefono3 == null)
                                        telefono3 = '';
                                    else
                                        telefono3 = '<li>' + telefono3 + '</li>';

                                    var email = element.email

                                    if (email == null)
                                        email = '';

                                    var note = element.note
                                    if (note == null)
                                        note = '';

                                    var JSON_tagNfc = element.tagNfc
                                    var tagNfc = '';
                                    if (JSON_tagNfc != null)
                                        tagNfc = JSON_tagNfc.tagNfc

                                    tagNfc = tagNfc.toUpperCase();
                                    //Prendo tutte le prestazioni effettuate per quell'intervento in quel range di date

                                    var url = 'https://' + base_url + '/services/interventiservice/api/erogazioni/ricerca?meseRiferimento=' + date_forcall + '&servizioId.equals=' + idservizio + '&progressivoAnnuo.contains=' + codice_intervento;

                                    $.ajax({
                                        url: url,
                                        type: 'GET',
                                        xhrFields: { withCredentials: true },
                                        crossDomain: true,
                                        dataType: 'json',
                                        beforeSend: function (xhr) {
                                            xhr.setRequestHeader('Authorization', 'Bearer ' + access_token);
                                            xhr.setRequestHeader('idEnte', idente);
                                            xhr.setRequestHeader('idStruttura', idstruttura);
                                        },
                                        success: function (res, textStatus, jqXHR) {

                                            var content = res.content
                                            //alert(JSON.stringify(content))
                                            $.each(content, function (index, element) {

                                                var idintervento_result = element.id

                                                if ($.inArray(idintervento_result, aINTERVENTI) == -1) {
                                                    aINTERVENTI.push(idintervento_result);
                                                    //if (idIntervento == idintervento_result) {
                                                    var codiceServizio = element.codiceServizio
                                                    var idTipoIntervento = element.idTipoIntervento
                                                    var tipoIntervento = element.tipoIntervento
                                                    var dataInizio = element.dataInizio
                                                    var dataFine = element.dataFine
                                                    //alert(dataFine)

                                                    //if (dataInizio <= oggi && dataFine >= oggi) 

                                                    if (dataInizio <= oggi) {
                                                        var soggetto = element.soggetto
                                                        //alert(soggetto)
                                                        var editabile = element.editabile
                                                        var idErogatore = element.idErogatore
                                                        var denominazioneErogatore = element.denominazioneErogatore
                                                        var certificazioneAccessi = element.certificazioneAccessi
                                                        var aEROGAZIONI = element.erogazioni

                                                        var flag_prestazione_attiva = false;

                                                        $.each(aEROGAZIONI, function (index, erogazione) {
                                                            var data_prestazione = index;
                                                            //Prendo tutte le prestazioni fatte quel giorno

                                                            if (oggi == data_prestazione) {

                                                                var idaccesso = erogazione.idAccesso
                                                                var statoValidazione = erogazione.statoValidazione
                                                                var aPRESTAZIONI = erogazione.prestazioni

                                                                $.each(aPRESTAZIONI, function (index, prestazione) {
                                                                    var idPrestazione = prestazione.idPrestazione
                                                                    var labelGruppoPrestazioni = prestazione.labelGruppoPrestazioni
                                                                    var coloreGruppoPrestazioni = prestazione.coloreGruppoPrestazioni
                                                                    var tipoPrestazione = prestazione.tipoPrestazione
                                                                    var quantita = prestazione.quantita
                                                                    var oraInizio = prestazione.oraInizio
                                                                    var oraFine = prestazione.oraFine
                                                                    var erogata = prestazione.erogata
                                                                    var fatturabile = prestazione.fatturabile
                                                                    var durata = prestazione.durata
                                                                    var longitudine_inizio = prestazione.longitudine_inizio
                                                                    var latitudine_inizio = prestazione.latitudine_inizio
                                                                    var longitudine_fine = prestazione.longitudine_fine
                                                                    var latitudine_fine = prestazione.latitudine_fine

                                                                    
                                                                    if ($.inArray(idPrestazione, aIDPRESTAZIONI) !== -1) {
                                                                        if ((oraInizio != null && oraFine == null) || (oraInizio != null && oraFine != null)) {
                                                                            var url = 'https://' + base_url + '/services/interventiservice/api/prestazioni/ricerca?id.equals=' + idPrestazione;
                                                                            $.ajax({
                                                                                url: url,
                                                                                type: 'GET',
                                                                                xhrFields: { withCredentials: true },
                                                                                crossDomain: true,
                                                                                dataType: 'json',
                                                                                beforeSend: function (xhr) {
                                                                                    xhr.setRequestHeader('Authorization', 'Bearer ' + access_token);
                                                                                    xhr.setRequestHeader('idEnte', idente);
                                                                                    xhr.setRequestHeader('idStruttura', idstruttura);
                                                                                },
                                                                                success: function (res, textStatus, jqXHR) {
                                                                                    var contentPrestazione = res.content
                                                                                    //alert(JSON.stringify(contentPrestazione))

                                                                                    //controllo se la prestazione che ho selezionato ha gli stessi tipi prestazione
                                                                                    var flag_continua = true;
                                                                                    $.each(contentPrestazione, function (index, element) {

                                                                                        var tipiPrestazione = element.tipiPrestazione

                                                                                        $.each(tipiPrestazione, function (index, tipoprestazione) {
                                                                                            if ($.inArray(tipoprestazione.id, aIDTIPIPRESTAZIONI) == -1)
                                                                                                flag_continua = false;
                                                                                        })

                                                                                    })

                                                                                    if (flag_continua) {
                                                                                        var class_div = '';
                                                                                        var descr_prestazione = '';
                                                                                        var h6hour = '';

                                                                                        if (oraInizio == null || oraInizio == "null") {
                                                                                            class_div = "noneseguita";
                                                                                            descr_prestazione = 'Prestazione non eseguita';
                                                                                        }
                                                                                        else if (oraFine == null || oraFine == "null") {
                                                                                            class_div = "eseguitaparziale";
                                                                                            descr_prestazione = 'Prestazione eseguita parziale';
                                                                                            h6hour = '<h6 class="font""><b>Ora inizio: </b>' + oraInizio + '<br></h6>'
                                                                                        }
                                                                                        else {
                                                                                            class_div = "eseguita";
                                                                                            descr_prestazione = 'Prestazione eseguita';
                                                                                            h6hour = '<h6 class="font" ><b>Ora inizio: </b>' + oraInizio + '<br><b>Ora Fine: </b>' + oraFine + '</h6>'
                                                                                        }

                                                                                        $("#div_prestazione_dettaglio").append('<div class=" container_div ' + class_div + '" style="padding:5%;">\
                                                                                                <div>\
                                                                                                    <h6 class="font" ><b>Nominativo: </b>'+ cognome + ' ' + nome + '</h6>\
                                                                                                    <h6 class="font" ><b>Indirizzo: </b>'+ indirizzoCompleto + ')</h6>\
                                                                                                    <h6 class="font" ><b>Comune: </b>'+ comune + ' (' + provincia + ')</h6>\
                                                                                                    <h6 class="font" ><b>Telefono </b>: <ul>'+ telefono1 + ' ' + telefono2 + ' ' + telefono3 + '</ul></h6>\
                                                                                                    <h6 class="font" ><b>Email: </b>'+ email + '</h6>\
                                                                                                    <input type="hidden" id="idaccesso" name="idaccesso" value="'+ idaccesso + '"/>\
                                                                                                    <h6 class="font"  ><b>Tipo: </b>'+ tipoPrestazione + '</h6>\
                                                                                                    <hr>\
                                                                                                    <h6 class="font" ><b>Note: </b>'+ note + '</h6>\
                                                                                                    <hr>\
                                                                                                    <h6 class="font" ><b>Data: </b>'+ get_formatDATE_standard(data_prestazione) + '</h6>\
                                                                                                    '+ h6hour + '\
                                                                                                </div>\
                                                                                            </div>');

                                                                                        if (oraFine == null) {
                                                                                            $("#div_prestazione_dettaglio").append('<div class="container_div_prestazione d-flex flex-row" style="margin-top:5%;" onclick="readNFC(\'' + idPrestazione + '\',\'' + oraInizio + '\',\'' + tagNfc + '\')">\
                                                                                            <div>\
                                                                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-play" viewBox="0 0 16 16">\
                                                                                                    <path d="M10.804 8 5 4.633v6.734L10.804 8zm.792-.696a.802.802 0 0 1 0 1.392l-6.363 3.692C4.713 12.69 4 12.345 4 11.692V4.308c0-.653.713-.998 1.233-.696l6.363 3.692z"/>\
                                                                                                </svg>\
                                                                                                <b>Termina con NFC</b>\
                                                                                            </div>\
                                                                                            </div>\
                                                                                            ');

                                                                                            $("#div_prestazione_dettaglio").append('<div class="container_div_prestazione d-flex flex-row" style="margin-top:5%;" onclick="openCAMERA(\'' + idPrestazione + '\',\'' + oraInizio + '\',\'' + codiceFiscale + '\',\'' + latitudine_inizio + '\',\'' + longitudine_inizio + '\')">\
                                                                                            <div>\
                                                                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-play" viewBox="0 0 16 16">\
                                                                                                    <path d="M10.804 8 5 4.633v6.734L10.804 8zm.792-.696a.802.802 0 0 1 0 1.392l-6.363 3.692C4.713 12.69 4 12.345 4 11.692V4.308c0-.653.713-.998 1.233-.696l6.363 3.692z"/>\
                                                                                                </svg>\
                                                                                                <b>Termina con Fotocamera</b>\
                                                                                            </div>\
                                                                                            </div>\
                                                                                            ');

                                                                                            $("#div_prestazione_dettaglio").append('<div class="container_div_elimina d-flex flex-row" onclick="eliminaConfirm(\'' + idPrestazione + '\')">\
                                                                                            <div>\
                                                                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">\
                                                                                                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>\
                                                                                                    <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>\
                                                                                                </svg>\
                                                                                                <b>Elimina Prestazione</b>\
                                                                                            </div>\
                                                                                            </div>\
                                                                                            ');
                                                                                        }
                                                                                    }
                                                                                    else {
                                                                                        $("#div_prestazione_dettaglio").append('<div class=" container_div_prestazione noneseguita" style="padding:5%;">\
                                                                                                <div>\
                                                                                                <h6 class="font"><b>Nominativo: </b>'+ cognome + ' ' + nome + '</h6>\
                                                                                                <h6 class="font"><b>Indirizzo: </b>'+ indirizzoCompleto + ')</h6>\
                                                                                                <h6 class="font"><b>Comune: </b>'+ comune + ' (' + provincia + ')</h6>\
                                                                                                <h6 class="font"><b>Telefono </b>: '+ telefono1 + ' ' + telefono2 + ' ' + telefono3 + '</h6>\
                                                                                                <h6 class="font"><b>Email: </b>'+ email + '</h6>\
                                                                                                <h6 class="font"><b>Tipo: </b>'+ descr_tipoprestazione + '</h6>\
                                                                                                <hr>\
                                                                                                <h6 class="font"><b>Note: </b>'+ note + '</h6>\
                                                                                                <hr>\
                                                                                                </div>\
                                                                                            </div>');

                                                                                        $("#div_prestazione_dettaglio").append('<div class="container_div_home d-flex flex-row" onclick="readNFC(' + null + ',' + null + ',\'' + tagNfc + '\')">\
                                                                                                <div>\
                                                                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-play" viewBox="0 0 16 16">\
                                                                                                        <path d="M10.804 8 5 4.633v6.734L10.804 8zm.792-.696a.802.802 0 0 1 0 1.392l-6.363 3.692C4.713 12.69 4 12.345 4 11.692V4.308c0-.653.713-.998 1.233-.696l6.363 3.692z"/>\
                                                                                                    </svg>\
                                                                                                    <b>Inizia con NFC</b>\
                                                                                                </div>\
                                                                                            </div>');

                                                                                        $("#div_prestazione_dettaglio").append('<div class="container_div_home d-flex flex-row" onclick="openCAMERA(' + null + ',' + null + ',\'' + codiceFiscale + '\')">\
                                                                                                <div>\
                                                                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-play" viewBox="0 0 16 16">\
                                                                                                        <path d="M10.804 8 5 4.633v6.734L10.804 8zm.792-.696a.802.802 0 0 1 0 1.392l-6.363 3.692C4.713 12.69 4 12.345 4 11.692V4.308c0-.653.713-.998 1.233-.696l6.363 3.692z"/>\
                                                                                                    </svg>\
                                                                                                    <b>Inizia con Fotocamera</b>\
                                                                                                </div>\
                                                                                            </div>');
                                                                                    }


                                                                                }
                                                                            })
                                                                        }
                                                                        flag_prestazione_attiva = true;
                                                                    }
                                                                });
                                                            }
                                                        });

                                                        if (!flag_prestazione_attiva) {
                                                            $("#div_prestazione_dettaglio").append('<div class=" container_div_prestazione noneseguita" style="padding:5%;">\
                                                                    <div>\
                                                                    <h6 class="font"><b>Nominativo: </b>'+ cognome + ' ' + nome + '</h6>\
                                                                    <h6 class="font"><b>Indirizzo: </b>'+ indirizzoCompleto + ')</h6>\
                                                                    <h6 class="font"><b>Comune: </b>'+ comune + ' (' + provincia + ')</h6>\
                                                                    <h6 class="font"><b>Telefono </b>: '+ telefono1 + ' ' + telefono2 + ' ' + telefono3 + '</h6>\
                                                                    <h6 class="font"><b>Email: </b>'+ email + '</h6>\
                                                                    <h6 class="font"><b>Tipo: </b>'+ descr_tipoprestazione + '</h6>\
                                                                    <hr>\
                                                                    <h6 class="font"><b>Note: </b>'+ note + '</h6>\
                                                                    <hr>\
                                                                    </div>\
                                                                </div>');

                                                            $("#div_prestazione_dettaglio").append('<div class="container_div_home d-flex flex-row" onclick="readNFC(' + null + ',' + null + ',\'' + tagNfc + '\')">\
                                                                    <div>\
                                                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-play" viewBox="0 0 16 16">\
                                                                            <path d="M10.804 8 5 4.633v6.734L10.804 8zm.792-.696a.802.802 0 0 1 0 1.392l-6.363 3.692C4.713 12.69 4 12.345 4 11.692V4.308c0-.653.713-.998 1.233-.696l6.363 3.692z"/>\
                                                                        </svg>\
                                                                        <b>Inizia con NFC</b>\
                                                                    </div>\
                                                                </div>');

                                                            $("#div_prestazione_dettaglio").append('<div class="container_div_home d-flex flex-row" onclick="openCAMERA(' + null + ',' + null + ',\'' + codiceFiscale + '\')">\
                                                                    <div>\
                                                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-play" viewBox="0 0 16 16">\
                                                                            <path d="M10.804 8 5 4.633v6.734L10.804 8zm.792-.696a.802.802 0 0 1 0 1.392l-6.363 3.692C4.713 12.69 4 12.345 4 11.692V4.308c0-.653.713-.998 1.233-.696l6.363 3.692z"/>\
                                                                        </svg>\
                                                                        <b>Inizia con Fotocamera</b>\
                                                                    </div>\
                                                                </div>');
                                                        }
                                                    }
                                                    else {

                                                    }
                                                }
                                            });
                                            $('#div_spinner').hide()

                                        },
                                        error: function (xhr, status, error) {
                                            if (xhr.status == 401) {
                                                $("#div_spinner").hide();
                                                function alertDismissed() {
                                                    window.location = "icaro_login.html";
                                                }

                                                navigator.notification.alert(
                                                    'Sessione scaduta, sarai reindirizzato alla pagina di login',  // message
                                                    alertDismissed,         // callback
                                                    'Attenzione',            // title
                                                    'Ok'                  // buttonName
                                                );
                                            }
                                            else
                                                alert(xhr.responseText)
                                        }
                                    });

                                });


                            },
                            error: function (xhr, status, error) {
                                if (xhr.status == 401) {
                                    $("#div_spinner").hide();
                                    function alertDismissed() {
                                        window.location = "icaro_login.html";
                                    }

                                    navigator.notification.alert(
                                        'Sessione scaduta, sarai reindirizzato alla pagina di login',  // message
                                        alertDismissed,         // callback
                                        'Attenzione',            // title
                                        'Ok'                  // buttonName
                                    );
                                }
                                else
                                    alert(xhr.responseText)
                            }

                        });
                    });
                }
                else {
                    alert("Nessun intervento attivo ad oggi - Redirect alla pagina Home")
                    window.location = "icaro_home.html";

                }
            }
        });
    }



    function back() {
        if (ptabellone == "1")
            window.location = "icaro_prestazioni_iniziate.html"
        else
            window.location = "icaro_ordine_servizio_dettaglio.html?_idintervento=" + idIntervento + "&codice=" + codice_intervento;

    }

    function readNFC(idPrestazione, ora_inizio, tagNfc_associato) {

        if (isiOS()) 
        {

            //per prima cosa controllo se c'è la geolocalizzazione attiva
            navigator.geolocation.getCurrentPosition(onSuccess, onError);

            var onSuccess = function (position) {
                alert('Latitude: ' + position.coords.latitude + '\n' +
                    'Longitude: ' + position.coords.longitude + '\n' +
                    'Altitude: ' + position.coords.altitude + '\n' +
                    'Accuracy: ' + position.coords.accuracy + '\n' +
                    'Altitude Accuracy: ' + position.coords.altitudeAccuracy + '\n' +
                    'Heading: ' + position.coords.heading + '\n' +
                    'Speed: ' + position.coords.speed + '\n' +
                    'Timestamp: ' + position.timestamp + '\n');

                window.nfc.enabled(
                    () => {
                        // NFC enabled
                        this.registerTagEvent(idPrestazione, ora_inizio, tagNfc_associato)

                    },
                    (error) => {
                        if (error === 'NFC_DISABLED') {
                            // Trigger the phone settings to enable the NFC settings
                            window.nfc.showSettings()
                        } else if (error === 'NO_NFC') {
                            navigator.notification.alert('Cannot scan NFC', () => { }, 'No NFC', 'OK')
                        }
                    }
                )

            };

            function onError(error) {
                function alertDismissed() {

                }

                navigator.notification.alert(
                    'GPS non rilevato, impossibile procedere con la timbratura',  // message
                    alertDismissed(),
                    "Attenzione!",
                    "OK",
                );

                //alert('code: '    + error.code    + '\n' + 'message: ' + error.message + '\n');
            }
        }
        else
        {
            cordova.plugins.diagnostic.isGpsLocationEnabled(function (enabled) {
                if (!enabled) {
                    function onRequestSuccess(success) {
                        var onSuccess = function (position) {
                            /*
                            alert('Latitude: ' + position.coords.latitude + '\n' +
                                'Longitude: ' + position.coords.longitude + '\n' +
                                'Altitude: ' + position.coords.altitude + '\n' +
                                'Accuracy: ' + position.coords.accuracy + '\n' +
                                'Altitude Accuracy: ' + position.coords.altitudeAccuracy + '\n' +
                                'Heading: ' + position.coords.heading + '\n' +
                                'Speed: ' + position.coords.speed + '\n' +
                                'Timestamp: ' + position.timestamp + '\n');
                            */
                                window.nfc.enabled(
                                    () => {
                                        // NFC enabled
                                        this.registerTagEvent(idPrestazione, ora_inizio, tagNfc_associato, position.coords.latitude, position.coords.longitude )

                                    },
                                    (error) => {
                                        if (error === 'NFC_DISABLED') {
                                            // Trigger the phone settings to enable the NFC settings
                                            window.nfc.showSettings()
                                        } else if (error === 'NO_NFC') {
                                            navigator.notification.alert('Cannot scan NFC', () => { }, 'No NFC', 'OK')
                                        }
                                    }
                                )
                        };


                        function onError(error) {

                            function alertDismissed() {
                            }

                            navigator.notification.alert(
                                'GPS non rilevato, impossibile procedere con la timbratura',  // message
                                alertDismissed(),
                                "Attenzione!",
                                "OK",
                            );

                            //alert('code: '    + error.code    + '\n' + 'message: ' + error.message + '\n');
                        }

                        navigator.geolocation.getCurrentPosition(onSuccess, onError);
                    }

                    function onRequestFailure(error) {
                        if (error.code !== cordova.plugins.locationAccuracy.ERROR_USER_DISAGREED) {
                            if (window.confirm('Impossibile impostare automaticamente la modalità di localizzazione su "Alta precisione". Desideri passare alla pagina Impostazioni posizione e farlo manualmente?')) {
                                cordova.plugins.diagnostic.switchToLocationSettings();
                            }
                        }
                    }

                    cordova.plugins.locationAccuracy.request(onRequestSuccess, onRequestFailure, cordova.plugins.locationAccuracy.REQUEST_PRIORITY_HIGH_ACCURACY);



                }
                else 
                {
                    var onSuccess = function (position) {
                        /*
                        alert('Latitude: ' + position.coords.latitude + '\n' +
                            'Longitude: ' + position.coords.longitude + '\n' +
                            'Altitude: ' + position.coords.altitude + '\n' +
                            'Accuracy: ' + position.coords.accuracy + '\n' +
                            'Altitude Accuracy: ' + position.coords.altitudeAccuracy + '\n' +
                            'Heading: ' + position.coords.heading + '\n' +
                            'Speed: ' + position.coords.speed + '\n' +
                            'Timestamp: ' + position.timestamp + '\n');
                        */
                            window.nfc.enabled(
                                    () => {
                                        // NFC enabled
                                        this.registerTagEvent(idPrestazione, ora_inizio, tagNfc_associato, position.coords.latitude, position.coords.longitude )

                                    },
                                    (error) => {
                                        if (error === 'NFC_DISABLED') {
                                            // Trigger the phone settings to enable the NFC settings
                                            window.nfc.showSettings()
                                        } else if (error === 'NO_NFC') {
                                            navigator.notification.alert('Cannot scan NFC', () => { }, 'No NFC', 'OK')
                                        }
                                    }
                                )
                    };


                    function onError(error) {

                        function alertDismissed() {
                        }

                        navigator.notification.alert(
                            'GPS non rilevato, impossibile procedere con la timbratura',  // message
                            alertDismissed(),
                            "Attenzione!",
                            "OK",
                        );

                        //alert('code: '    + error.code    + '\n' + 'message: ' + error.message + '\n');
                    }

                    navigator.geolocation.getCurrentPosition(onSuccess, onError);
                }

            }, function (error) {
                alert("The following error occurred: " + error);
            });
        
        }
    }

    function registerTagEvent(idPrestazione, ora_inizio, tagNfc_associato, latitudine, longitudine) {
        window.nfc.addNdefListener(
            this.onSuccess(idPrestazione, ora_inizio, tagNfc_associato),
            () => {
                navigator.notification.activityStart('', 'Lettura tag nfc in corso, appoggiare la tessera NFC nel retro del dispositivo');
            },
            (error) => {
                console.log('failure registering ndef listener', error)
            }
        )
    }

    function onFailure() {
        nfc.showSettings();
    }

    function onSuccess(idPrestazione, ora_inizio, tagNfc_associato) {

        navigator.notification.beep(1);
        if (isiOS()) {

            nfc.scanTag().then(
                tag => {
                    if (tag.id) {
                        console.log("2.1: " + nfc.bytesToHexString(tag.id));
                        readSuccess(tag, idPrestazione, ora_inizio, tagNfc_associato)
                    }
                },
                err => console.log(err)
            );


        }
        else {

            nfc.readerMode(nfc.FLAG_READER_NFC_A, nfcTag => readSuccess(nfcTag, idPrestazione, ora_inizio, tagNfc_associato), error => alert('NFC reader mode failed', error));

        }

    }

    function readSuccess(nfcTag, idPrestazione, ora_inizio, tagNfc_associato) {
        //controllare il tag
        var tagId = nfc.bytesToHexString(nfcTag.id); //tag della tessera
        //var tagId = nfcTag.id;
        tagId = tagId.toUpperCase();
        var realms = localStorage.getItem('realm');
        var base_url = localStorage.getItem('base_url');

        //tagNfc_associato -> tag associato all'utente
        //tagId="0482510AE37380"
        //alert(tagId)
        //alert(tagNfc_associato)
        if (tagNfc_associato == tagId) {
            var ora = getTIME()

            //return false;
            //alert(ora_inizio)

            /*
            if (idtipoprestazione.indexOf(',') != -1) 
                var aIDTIPIPRESTAZIONI = idtipoprestazione.split(',');
            else
            {
                var aIDTIPIPRESTAZIONI = [];
                aIDTIPIPRESTAZIONI.push(idtipoprestazione)
            }
            */
            //var count_element=aIDTIPIPRESTAZIONI.length;

            //return false;

            if (ora_inizio == null && idPrestazione == null) //prestazione nuova faccio una POST
            {
                //!!!!controllare se il soggetto corrisponde al soggetto del tag nfc!!!


                var body = {
                    'idIntervento': idIntervento,
                    'idGruppoPrestazione': idgruppo,
                    'listaIdTipiPrestazione': aIDTIPIPRESTAZIONI,
                    'quantita': 1, //è il numero di prestazioni
                    "oraInizio": ora,
                    'erogata': true,
                    'fatturabile': true,
                    'dataAccesso': oggi
                };
                var aBODY = JSON.stringify(body);
                //alert("POST: " + aBODY)
                //return false;

                var url = 'https://' + base_url + '/services/interventiservice/api/prestazioni';

                $.ajax({
                    url: url,
                    type: "POST",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    xhrFields: { withCredentials: true },
                    data: aBODY,
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader('Authorization', 'Bearer ' + access_token);
                        xhr.setRequestHeader('idEnte', idente);
                        xhr.setRequestHeader('idStruttura', idstruttura);
                    },
                    success: function (data, status, settings) {

                        var idprestazione = data.id;
                        //alert("ID prestazione: " + idprestazione)
                        var username = localStorage.getItem('username');

                        var body_request = {
                            'idPrestazione': idprestazione,
                            'cognome': username,
                            'nome': username,
                        };
                        var aBODYrequest = JSON.stringify(body_request);

                        //alert("Body : " + aBODYrequest)

                        var url = 'https://' + base_url + '/services/interventiservice/api/prestazioni-operatori';

                        $.ajax({
                            url: url,
                            type: "POST",
                            contentType: "application/json; charset=utf-8",
                            dataType: "json",
                            xhrFields: { withCredentials: true },
                            data: aBODYrequest,
                            beforeSend: function (xhr) {
                                xhr.setRequestHeader('Authorization', 'Bearer ' + access_token);
                                xhr.setRequestHeader('idEnte', idente);
                                xhr.setRequestHeader('idStruttura', idstruttura);
                            },
                            success: function (data, status, settings) {
                                //$("#div_spinner").hide();
                                //alert("associazione creata")
                                var result = JSON.stringify(data);
                                //alert("DATA: " + result)
                                if (!isiOS())
                                    navigator.notification.activityStop();

                                var IDprestazioni = localStorage.getItem('_idprestazione');
                                var aIDPRESTAZIONI = []
                                if (IDprestazioni != null && IDprestazioni != undefined && IDprestazioni != '') {
                                    aIDPRESTAZIONI = IDprestazioni.split(',');
                                    if ($.inArray(idprestazione, aIDPRESTAZIONI) !== -1)
                                        aIDPRESTAZIONI.push(idprestazione)
                                }
                                else
                                    aIDPRESTAZIONI.push(idprestazione)


                                localStorage.setItem('_idprestazione', aIDPRESTAZIONI);

                                function alertDismissed() {
                                    window.location = "icaro_prestazione_dettaglio.html?idgruppo=" + idgruppo + "&idtipoprestazione=" + idtipoprestazione + "&descr_tipoprestazione=" + descr_tipoprestazione + "&idintervento=" + idIntervento + "&codice=" + codice_intervento + "&_idprestazione=" + idprestazione + "&_tabellone=" + ptabellone + "&_tabellone=" + ptabellone;;
                                }


                                navigator.notification.alert(
                                    'Timbratura avvenuta con successo',  // message
                                    alertDismissed(),
                                    "Success",
                                    "Continua",
                                );
                            },
                            error: function (jqXHR, textStatus, errorThrown) {
                                if (!isiOS())
                                    navigator.notification.activityStop();

                                if (jqXHR.status == 401) {
                                    //$("#div_spinner").hide();
                                    function alertDismissed_login() {
                                        window.location = "icaro_login.html";
                                    }

                                    navigator.notification.alert(
                                        'Sessione scaduta, sarai reindirizzato alla pagina di login',  // message
                                        alertDismissed_login,         // callback
                                        'Attenzione',            // title
                                        'Ok'                  // buttonName
                                    );
                                }
                                else
                                    alert("ERRORE: " + jqXHR.responseText)
                            }
                        });
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        if (!isiOS())
                            navigator.notification.activityStop();
                        if (jqXHR.status == 401) {
                            //$("#div_spinner").hide();
                            function alertDismissed_login() {
                                window.location = "icaro_login.html";
                            }

                            navigator.notification.alert(
                                'Sessione scaduta, sarai reindirizzato alla pagina di login',  // message
                                alertDismissed_login,         // callback
                                'Attenzione',            // title
                                'Ok'                  // buttonName
                            );
                        }
                        else
                            alert("ERRORE: " + jqXHR.responseText)
                    }
                });

            }
            else {

                var idaccesso = $('#idaccesso').val()

                var body = {
                    'id': idPrestazione,
                    'version': 0,
                    'idAccesso': idaccesso,
                    "idGruppoPrestazione": idgruppo,
                    'listaIdTipiPrestazione': aIDTIPIPRESTAZIONI,
                    'quantita': 1, //è il numero di prestazioni
                    'oraInizio': ora_inizio,
                    'oraFine': ora,
                    "erogata": true,
                    "fatturabile": true
                };
                var aBODY = JSON.stringify(body);
                //alert("PUT: " + aBODY)
                //return false;

                var url = 'https://' + base_url + '/services/interventiservice/api/prestazioni';

                $.ajax({
                    url: url,
                    type: "PUT",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    xhrFields: { withCredentials: true },
                    data: aBODY,
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader('Authorization', 'Bearer ' + access_token);
                        xhr.setRequestHeader('idEnte', idente);
                        xhr.setRequestHeader('idStruttura', idstruttura);
                    },
                    success: function (data, status, settings) {
                        var aDATA = JSON.stringify(data);
                        if (!isiOS())
                            navigator.notification.activityStop();
                        //$("#div_spinner").hide();
                        var IDprestazioni = localStorage.getItem('_idprestazione');
                        var aIDPRESTAZIONI = IDprestazioni.split(',')

                        if ($.inArray(idPrestazione, aIDPRESTAZIONI) !== -1) {
                            aIDPRESTAZIONI = $.grep(aIDPRESTAZIONI, function (value) {
                                return value != idPrestazione;
                            });
                        }

                        localStorage.setItem('_idprestazione', aIDPRESTAZIONI);

                        function alertDismissed() {
                            window.location = "icaro_prestazione_dettaglio.html?idgruppo=" + idgruppo + "&idtipoprestazione=" + idtipoprestazione + "&descr_tipoprestazione=" + descr_tipoprestazione + "&idintervento=" + idIntervento + "&codice=" + codice_intervento + "&_idprestazione=" + idPrestazione + "&_tabellone=" + ptabellone;;
                        }

                        navigator.notification.alert(
                            'Timbratura avvenuta con successo',  // message
                            alertDismissed(),
                            "Success",
                            "Continua",
                        );


                        //alert("DATA: " + aDATA)

                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        if (!isiOS())
                            navigator.notification.activityStop();
                        if (jqXHR.status == 401) {
                            //$("#div_spinner").hide();
                            function alertDismissed_login() {
                                window.location = "icaro_login.html";
                            }

                            navigator.notification.alert(
                                'Sessione scaduta, sarai reindirizzato alla pagina di login',  // message
                                alertDismissed_login,         // callback
                                'Attenzione',            // title
                                'Ok'                  // buttonName
                            );
                        }
                        else
                            alert("ERRORE: " + jqXHR.responseText)
                    }
                });
            }
        }
        else {
            if (!isiOS())
                navigator.notification.activityStop();

            function alertDismissed() {

            }

            navigator.notification.alert(
                'Tessera NFC associata ad un altro beneficiario!\nImpossibile procedere con la timbratura',  // message
                alertDismissed,         // callback
                'Attenzione!',            // title
                'Ok'                  // buttonName
            );
        }

    }

    function eliminaConfirm(idPrestazione) {
        var realms = localStorage.getItem('realm');
        var base_url = localStorage.getItem('base_url');

        if (idPrestazione != 0 && idPrestazione != null && idPrestazione != 'undefined') {

            navigator.notification.confirm(
                'Vuoi procedere con l\'eliminazione definitiva della prestazione selezionata?',
                elimina,
                'Elimina',
                ['Elimina', 'Annulla']
            );

            function elimina(button) {
                if (button == 1) {

                    var url = 'https://' + base_url + '/services/interventiservice/api/prestazioni/' + idPrestazione;

                    $.ajax({
                        url: url,
                        type: "DELETE",
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        xhrFields: { withCredentials: true },
                        beforeSend: function (xhr) {
                            xhr.setRequestHeader('Authorization', 'Bearer ' + access_token);
                            xhr.setRequestHeader('idEnte', idente);
                            xhr.setRequestHeader('idStruttura', idstruttura);
                        },
                        success: function (data, status, settings) {
                            if (data == true) {

                                var IDprestazioni = localStorage.getItem('_idprestazione');
                                var aIDPRESTAZIONI = IDprestazioni.split(',')

                                if ($.inArray(idPrestazione, aIDPRESTAZIONI) !== -1) {
                                    aIDPRESTAZIONI = $.grep(aIDPRESTAZIONI, function (value) {
                                        return value != idPrestazione;
                                    });
                                }

                                localStorage.setItem('_idprestazione', aIDPRESTAZIONI);

                                function alertDismissed() {
                                    window.location = "icaro_prestazione_dettaglio.html?idgruppo=" + idgruppo + "&idtipoprestazione=" + idtipoprestazione + "&descr_tipoprestazione=" + descr_tipoprestazione + "&idintervento=" + idIntervento + "&codice=" + codice_intervento + "&_tabellone=" + ptabellone;;
                                }

                                navigator.notification.alert(
                                    'Eliminazione avvenuta con successo',  // message
                                    alertDismissed(),
                                    "Success",
                                    "Continua",
                                );
                            }

                            $("#div_spinner").hide();

                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            if (jqXHR.status == 401) {
                                $("#div_spinner").hide();
                                function alertDismissed() {
                                    window.location = "icaro_login.html";
                                }

                                navigator.notification.alert(
                                    'Sessione scaduta, sarai reindirizzato alla pagina di login',  // message
                                    alertDismissed,         // callback
                                    'Attenzione',            // title
                                    'Ok'                  // buttonName
                                );
                            }
                            else
                                alert("ERRORE: " + jqXHR.responseText)
                        }
                    });

                }
            }
        }
    }


    function openCAMERA(idPrestazione, ora_inizio, codice_fiscale) {

        if (isiOS()) {
            var onSuccess = function (position) {
                alert('Latitude: ' + position.coords.latitude + '\n' +
                    'Longitude: ' + position.coords.longitude + '\n' +
                    'Altitude: ' + position.coords.altitude + '\n' +
                    'Accuracy: ' + position.coords.accuracy + '\n' +
                    'Altitude Accuracy: ' + position.coords.altitudeAccuracy + '\n' +
                    'Heading: ' + position.coords.heading + '\n' +
                    'Speed: ' + position.coords.speed + '\n' +
                    'Timestamp: ' + position.timestamp + '\n');

                cordova.plugins.barcodeScanner.scan(
                    function (result) {
                        if (result.text != '') {
                            if (result.text == codice_fiscale)
                                readSuccessCAMERA(result.text, idPrestazione, ora_inizio, codice_fiscale, position.coords.latitude, position.coords.longitude)
                            else {
                                function alertDismissed() {

                                }

                                navigator.notification.alert(
                                    'Tessera associata ad un altro beneficiario!\nImpossibile procedere con la timbratura',  // message
                                    alertDismissed,         // callback
                                    'Attenzione!',            // title
                                    'Ok'                  // buttonName
                                );
                            }
                        }
                        else {
                            function alertDismissed() {

                            }

                            navigator.notification.alert(
                                'Anomalia nella lettura della tessera, tag vuoto',  // message
                                alertDismissed,         // callback
                                'Attenzione!',            // title
                                'Ok'                  // buttonName
                            );

                        }
                    },
                    function (error) {
                        alert("Scanning failed: " + error);
                    },
                    {
                        preferFrontCamera: false, // iOS and Android
                        showFlipCameraButton: true, // iOS and Android
                        showTorchButton: true, // iOS and Android
                        torchOn: false, // Android, launch with the torch switched on (if available)
                        saveHistory: true, // Android, save scan history (default false)
                        prompt: "Inquadra il codice a barre della tessera", // Android
                        resultDisplayDuration: 500, // Android, display scanned text for X ms. 0 suppresses it entirely, default 1500
                        formats: "QR_CODE,PDF_417,Code39", // default: all but PDF_417 and RSS_EXPANDED
                        //orientation : "landscape", // Android only (portrait|landscape), default unset so it rotates with the device
                        disableAnimations: true, // iOS
                        disableSuccessBeep: false // iOS and Android
                    }
                );
            };


            function onError(error) {

                function alertDismissed() {
                }

                navigator.notification.alert(
                    'GPS non rilevato, impossibile procedere con la timbratura',  // message
                    alertDismissed(),
                    "Attenzione!",
                    "OK",
                );

                //alert('code: '    + error.code    + '\n' + 'message: ' + error.message + '\n');
            }

            navigator.geolocation.getCurrentPosition(onSuccess, onError);
        }
        else {
            cordova.plugins.diagnostic.isGpsLocationEnabled(function (enabled) {
                if (!enabled) {
                    function onRequestSuccess(success) {
                        var onSuccess = function (position) {
                            alert('Latitude: ' + position.coords.latitude + '\n' +
                                'Longitude: ' + position.coords.longitude + '\n' +
                                'Altitude: ' + position.coords.altitude + '\n' +
                                'Accuracy: ' + position.coords.accuracy + '\n' +
                                'Altitude Accuracy: ' + position.coords.altitudeAccuracy + '\n' +
                                'Heading: ' + position.coords.heading + '\n' +
                                'Speed: ' + position.coords.speed + '\n' +
                                'Timestamp: ' + position.timestamp + '\n');

                            cordova.plugins.barcodeScanner.scan(
                                function (result) {
                                    if (result.text != '') {
                                        if (result.text == codice_fiscale)
                                            readSuccessCAMERA(result.text, idPrestazione, ora_inizio, codice_fiscale, position.coords.latitude, position.coords.longitude)
                                        else {
                                            function alertDismissed() {

                                            }

                                            navigator.notification.alert(
                                                'Tessera associata ad un altro beneficiario!\nImpossibile procedere con la timbratura',  // message
                                                alertDismissed,         // callback
                                                'Attenzione!',            // title
                                                'Ok'                  // buttonName
                                            );
                                        }
                                    }
                                    else {
                                        function alertDismissed() {

                                        }

                                        navigator.notification.alert(
                                            'Anomalia nella lettura della tessera, tag vuoto',  // message
                                            alertDismissed,         // callback
                                            'Attenzione!',            // title
                                            'Ok'                  // buttonName
                                        );

                                    }
                                },
                                function (error) {
                                    alert("Scanning failed: " + error);
                                },
                                {
                                    preferFrontCamera: false, // iOS and Android
                                    showFlipCameraButton: true, // iOS and Android
                                    showTorchButton: true, // iOS and Android
                                    torchOn: false, // Android, launch with the torch switched on (if available)
                                    saveHistory: true, // Android, save scan history (default false)
                                    prompt: "Inquadra il codice a barre della tessera", // Android
                                    resultDisplayDuration: 500, // Android, display scanned text for X ms. 0 suppresses it entirely, default 1500
                                    formats: "QR_CODE,PDF_417,Code39", // default: all but PDF_417 and RSS_EXPANDED
                                    //orientation : "landscape", // Android only (portrait|landscape), default unset so it rotates with the device
                                    disableAnimations: true, // iOS
                                    disableSuccessBeep: false // iOS and Android
                                }
                            );
                        };


                        function onError(error) {

                            function alertDismissed() {
                            }

                            navigator.notification.alert(
                                'GPS non rilevato, impossibile procedere con la timbratura',  // message
                                alertDismissed(),
                                "Attenzione!",
                                "OK",
                            );

                            //alert('code: '    + error.code    + '\n' + 'message: ' + error.message + '\n');
                        }

                        navigator.geolocation.getCurrentPosition(onSuccess, onError);
                    }

                    function onRequestFailure(error) {
                        if (error.code !== cordova.plugins.locationAccuracy.ERROR_USER_DISAGREED) {
                            if (window.confirm('Impossibile impostare automaticamente la modalità di localizzazione su "Alta precisione". Desideri passare alla pagina Impostazioni posizione e farlo manualmente?')) {
                                cordova.plugins.diagnostic.switchToLocationSettings();
                            }
                        }
                    }

                    cordova.plugins.locationAccuracy.request(onRequestSuccess, onRequestFailure, cordova.plugins.locationAccuracy.REQUEST_PRIORITY_HIGH_ACCURACY);



                }
                else 
                {
                    var onSuccess = function (position) {
                        alert('Latitude: ' + position.coords.latitude + '\n' +
                            'Longitude: ' + position.coords.longitude + '\n' +
                            'Altitude: ' + position.coords.altitude + '\n' +
                            'Accuracy: ' + position.coords.accuracy + '\n' +
                            'Altitude Accuracy: ' + position.coords.altitudeAccuracy + '\n' +
                            'Heading: ' + position.coords.heading + '\n' +
                            'Speed: ' + position.coords.speed + '\n' +
                            'Timestamp: ' + position.timestamp + '\n');

                        cordova.plugins.barcodeScanner.scan(
                            function (result) {
                                if (result.text != '') {
                                    if (result.text == codice_fiscale)
                                        readSuccessCAMERA(result.text, idPrestazione, ora_inizio, codice_fiscale, position.coords.latitude, position.coords.longitude)
                                    else {
                                        function alertDismissed() {

                                        }

                                        navigator.notification.alert(
                                            'Tessera associata ad un altro beneficiario!\nImpossibile procedere con la timbratura',  // message
                                            alertDismissed,         // callback
                                            'Attenzione!',            // title
                                            'Ok'                  // buttonName
                                        );
                                    }
                                }
                                else {
                                    function alertDismissed() {

                                    }

                                    navigator.notification.alert(
                                        'Anomalia nella lettura della tessera, tag vuoto',  // message
                                        alertDismissed,         // callback
                                        'Attenzione!',            // title
                                        'Ok'                  // buttonName
                                    );

                                }
                            },
                            function (error) {
                                alert("Scanning failed: " + error);
                            },
                            {
                                preferFrontCamera: false, // iOS and Android
                                showFlipCameraButton: true, // iOS and Android
                                showTorchButton: true, // iOS and Android
                                torchOn: false, // Android, launch with the torch switched on (if available)
                                saveHistory: true, // Android, save scan history (default false)
                                prompt: "Inquadra il codice a barre della tessera", // Android
                                resultDisplayDuration: 500, // Android, display scanned text for X ms. 0 suppresses it entirely, default 1500
                                formats: "QR_CODE,PDF_417,Code39", // default: all but PDF_417 and RSS_EXPANDED
                                //orientation : "landscape", // Android only (portrait|landscape), default unset so it rotates with the device
                                disableAnimations: true, // iOS
                                disableSuccessBeep: false // iOS and Android
                            }
                        );
                    };


                    function onError(error) {

                        function alertDismissed() {
                        }

                        navigator.notification.alert(
                            'GPS non rilevato, impossibile procedere con la timbratura',  // message
                            alertDismissed(),
                            "Attenzione!",
                            "OK",
                        );

                        //alert('code: '    + error.code    + '\n' + 'message: ' + error.message + '\n');
                    }

                    navigator.geolocation.getCurrentPosition(onSuccess, onError);
                }

            }, function (error) {
                alert("The following error occurred: " + error);
            });
        }

    }

    function readSuccessCAMERA(codicefiscale_letto, idPrestazione, ora_inizio, codicefiscale_associato, latitudine, longitudine) {

        var realms = localStorage.getItem('realm');
        var base_url = localStorage.getItem('base_url');

        if (codicefiscale_letto == codicefiscale_associato) {
            var ora = getTIME()

            if (ora_inizio == null && idPrestazione == null) //prestazione nuova faccio una POST
            {

                var body = {
                    'idIntervento': idIntervento,
                    'idGruppoPrestazione': idgruppo,
                    'listaIdTipiPrestazione': aIDTIPIPRESTAZIONI,
                    'quantita': 1, //è il numero di prestazioni
                    "oraInizio": ora,
                    'erogata': true,
                    'fatturabile': true,
                    'dataAccesso': oggi
                };
                var aBODY = JSON.stringify(body);
                //alert("POST: " + aBODY)
                //return false;

                var url = 'https://' + base_url + '/services/interventiservice/api/prestazioni';

                $.ajax({
                    url: url,
                    type: "POST",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    xhrFields: { withCredentials: true },
                    data: aBODY,
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader('Authorization', 'Bearer ' + access_token);
                        xhr.setRequestHeader('idEnte', idente);
                        xhr.setRequestHeader('idStruttura', idstruttura);
                    },
                    success: function (data, status, settings) {

                        var idprestazione = data.id;
                        //alert("ID prestazione: " + idprestazione)
                        var username = localStorage.getItem('username');

                        var body_request = {
                            'idPrestazione': idprestazione,
                            'cognome': username,
                            'nome': username,
                        };
                        var aBODYrequest = JSON.stringify(body_request);

                        //alert("Body : " + aBODYrequest)

                        var url = 'https://' + base_url + '/services/interventiservice/api/prestazioni-operatori';

                        $.ajax({
                            url: url,
                            type: "POST",
                            contentType: "application/json; charset=utf-8",
                            dataType: "json",
                            xhrFields: { withCredentials: true },
                            data: aBODYrequest,
                            beforeSend: function (xhr) {
                                xhr.setRequestHeader('Authorization', 'Bearer ' + access_token);
                                xhr.setRequestHeader('idEnte', idente);
                                xhr.setRequestHeader('idStruttura', idstruttura);
                            },
                            success: function (data, status, settings) {
                                //$("#div_spinner").hide();
                                //alert("associazione creata")
                                var result = JSON.stringify(data);
                                //alert("DATA: " + result)

                                var IDprestazioni = localStorage.getItem('_idprestazione');
                                var aIDPRESTAZIONI = []
                                if (IDprestazioni != null && IDprestazioni != undefined && IDprestazioni != '') {
                                    aIDPRESTAZIONI = IDprestazioni.split(',');
                                    if ($.inArray(idprestazione, aIDPRESTAZIONI) !== -1)
                                        aIDPRESTAZIONI.push(idprestazione)
                                }
                                else
                                    aIDPRESTAZIONI.push(idprestazione)


                                localStorage.setItem('_idprestazione', aIDPRESTAZIONI);

                                function alertDismissed() {
                                    window.location = "icaro_prestazione_dettaglio.html?idgruppo=" + idgruppo + "&idtipoprestazione=" + idtipoprestazione + "&descr_tipoprestazione=" + descr_tipoprestazione + "&idintervento=" + idIntervento + "&codice=" + codice_intervento + "&_idprestazione=" + idprestazione + "&_tabellone=" + ptabellone + "&_tabellone=" + ptabellone;;
                                }


                                navigator.notification.alert(
                                    'Timbratura avvenuta con successo',  // message
                                    alertDismissed(),
                                    "Success",
                                    "Continua",
                                );
                            },
                            error: function (jqXHR, textStatus, errorThrown) {

                                localStorage.removeItem('access_token');

                                if (jqXHR.status == 401) {
                                    //$("#div_spinner").hide();
                                    function alertDismissed_login() {
                                        window.location = "index.html";
                                    }

                                    navigator.notification.alert(
                                        'Sessione scaduta, sarai reindirizzato alla pagina di login',  // message
                                        alertDismissed_login,         // callback
                                        'Attenzione',            // title
                                        'Ok'                  // buttonName
                                    );
                                }
                                else
                                    alert("ERRORE: " + jqXHR.responseText)
                            }
                        });
                    },
                    error: function (jqXHR, textStatus, errorThrown) {

                        localStorage.removeItem('access_token');

                        if (jqXHR.status == 401) {
                            //$("#div_spinner").hide();
                            function alertDismissed_login() {
                                window.location = "index.html";
                            }

                            navigator.notification.alert(
                                'Sessione scaduta, sarai reindirizzato alla pagina di login',  // message
                                alertDismissed_login,         // callback
                                'Attenzione',            // title
                                'Ok'                  // buttonName
                            );
                        }
                        else
                            alert("ERRORE: " + jqXHR.responseText)
                    }
                });

            }
            else {

                var idaccesso = $('#idaccesso').val()

                var body = {
                    'id': idPrestazione,
                    'version': 0,
                    'idAccesso': idaccesso,
                    "idGruppoPrestazione": idgruppo,
                    'listaIdTipiPrestazione': aIDTIPIPRESTAZIONI,
                    'quantita': 1, //è il numero di prestazioni
                    'oraInizio': ora_inizio,
                    'oraFine': ora,
                    "erogata": true,
                    "fatturabile": true
                };
                var aBODY = JSON.stringify(body);
                //alert("PUT: " + aBODY)
                //return false;

                var url = 'https://' + base_url + '/services/interventiservice/api/prestazioni';

                $.ajax({
                    url: url,
                    type: "PUT",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    xhrFields: { withCredentials: true },
                    data: aBODY,
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader('Authorization', 'Bearer ' + access_token);
                        xhr.setRequestHeader('idEnte', idente);
                        xhr.setRequestHeader('idStruttura', idstruttura);
                    },
                    success: function (data, status, settings) {
                        var aDATA = JSON.stringify(data);
                        if (!isiOS())
                            navigator.notification.activityStop();
                        //$("#div_spinner").hide();
                        var IDprestazioni = localStorage.getItem('_idprestazione');
                        var aIDPRESTAZIONI = IDprestazioni.split(',')

                        if ($.inArray(idPrestazione, aIDPRESTAZIONI) !== -1) {
                            aIDPRESTAZIONI = $.grep(aIDPRESTAZIONI, function (value) {
                                return value != idPrestazione;
                            });
                        }

                        localStorage.setItem('_idprestazione', aIDPRESTAZIONI);

                        function alertDismissed() {
                            window.location = "icaro_prestazione_dettaglio.html?idgruppo=" + idgruppo + "&idtipoprestazione=" + idtipoprestazione + "&descr_tipoprestazione=" + descr_tipoprestazione + "&idintervento=" + idIntervento + "&codice=" + codice_intervento + "&_idprestazione=" + idPrestazione + "&_tabellone=" + ptabellone;;
                        }

                        navigator.notification.alert(
                            'Timbratura avvenuta con successo',  // message
                            alertDismissed(),
                            "Success",
                            "Continua",
                        );


                        //alert("DATA: " + aDATA)

                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        localStorage.removeItem('access_token');

                        if (jqXHR.status == 401) {
                            //$("#div_spinner").hide();
                            function alertDismissed_login() {
                                window.location = "index.html";
                            }

                            navigator.notification.alert(
                                'Sessione scaduta, sarai reindirizzato alla pagina di login',  // message
                                alertDismissed_login,         // callback
                                'Attenzione',            // title
                                'Ok'                  // buttonName
                            );
                        }
                        else
                            alert("ERRORE: " + jqXHR.responseText)
                    }
                });
            }
        }
        else {

            function alertDismissed() {

            }

            navigator.notification.alert(
                'Tessera associata ad un altro beneficiario!\nImpossibile procedere con la timbratura',  // message
                alertDismissed,         // callback
                'Attenzione!',            // title
                'Ok'                  // buttonName
            );
        }

    }

</script>